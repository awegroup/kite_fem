import matplotlib.pyplot as plt
import numpy as np
from kite_fem.FEMStructure import FEM_structure

# Define initial conditions and connectivity matrix
initial_conditions = [[[0.0, 0.0, 0.0], [0.0, 0.0, 0.0], 0.661345363420986, True], [[1.5450326776836745, 4.130039796867375, 7.261364950271782], [0.0, 0.0, 0.0], 0.6054251074570364, False], [[-0.01769468978128639, 3.9841196033007544, 8.497033387639695], [0.0, 0.0, 0.0], 0.5707213947602356, False], [[-0.23864988658488862, 3.147085371141592, 9.816746227504566], [0.0, 0.0, 0.0], 0.5752129756233141, False], [[-0.3852940131556698, 1.9677011127725468, 10.6073565473802], [0.0, 0.0, 0.0], 0.5760255005323119, False], [[-0.4584192791195412, 0.6669541551721638, 10.948973784300064], [0.0, 0.0, 0.0], 0.5788983834737577, False], [[-0.4584192791195412, -0.6669541551721638, 10.948973784300064], [0.0, 0.0, 0.0], 0.5788983834737577, False], [[-0.3852940131556698, -1.9677011127725468, 10.6073565473802], [0.0, 0.0, 0.0], 0.5760255005323119, False], [[-0.23864988658488862, -3.147085371141592, 9.816746227504566], [0.0, 0.0, 0.0], 0.5752129756233141, False], [[-0.01769468978128639, -3.9841196033007544, 8.497033387639695], [0.0, 0.0, 0.0], 0.5707213947602356, False], [[1.5450326776836745, -4.130039796867375, 7.261364950271782], [0.0, 0.0, 0.0], 0.6054251074570364, False], [[1.7103966474299823, -3.9715968676171474, 8.492040169869373], [0.0, 0.0, 0.0], 0.5654576443671213, False], [[2.0106621688737727, -3.12943184814695, 9.787197879905024], [0.0, 0.0, 0.0], 0.5728514884728007, False], [[2.118729000086964, -1.9545056515510937, 10.55854695742184], [0.0, 0.0, 0.0], 0.575770732822115, False], [[2.16733994663813, -0.6634087911809183, 10.889841638961673], [0.0, 0.0, 0.0], 0.578854001974007, False], [[2.16733994663813, 0.6634087911809183, 10.889841638961673], [0.0, 0.0, 0.0], 0.578854001974007, False], [[2.118729000086964, 1.9545056515510937, 10.55854695742184], [0.0, 0.0, 0.0], 0.575770732822115, False], [[2.0106621688737727, 3.12943184814695, 9.787197879905024], [0.0, 0.0, 0.0], 0.5728514884728007, False], [[1.7103966474299823, 3.9715968676171474, 8.492040169869373], [0.0, 0.0, 0.0], 0.5654576443671213, False], [[0.8630767430175426, 4.1565, 7.423819809051551], [0.0, 0.0, 0.0], 0.6206859968952704, False], [[0.8630767430175426, -4.1565, 7.423819809051551], [0.0, 0.0, 0.0], 0.0706859968952703, False], [[0.17884119251811076, 0.0, 0.9330143770911036], [0.0, 0.0, 0.0], 8.447411093293947, False], [[0.4176659156066993, 0.0, 2.0047264427326446], [0.0, 0.0, 0.0], 0.06165064275796516, False], [[0.4765199236180079, 0.515701635045511, 2.4187272340933115], [0.0, 0.0, 0.0], 0.09102212303016835, False], [[1.0118690598081908, 0.85948465466864, 4.671178520435504], [0.0, 0.0, 0.0], 0.24485626871062102, False], [[1.447067774285811, 2.71993276851239, 7.354965134765166], [0.0, 0.0, 0.0], 0.0680648306878911, False], [[1.5342469795828642, 1.3437933594787979, 7.833401527870664], [0.0, 0.0, 0.0], 0.08390189207122503, False], [[0.4765199236180079, -0.515701635045511, 2.4187272340933115], [0.0, 0.0, 0.0], 0.09102212303016835, False], [[1.0118690598081908, -0.85948465466864, 4.671178520435504], [0.0, 0.0, 0.0], 0.24485626871062102, False], [[1.447067774285811, -2.71993276851239, 7.354965134765166], [0.0, 0.0, 0.0], 0.0680648306878911, False], [[1.5342469795828642, -1.3437933594787979, 7.833401527870664], [0.0, 0.0, 0.0], 0.08390189207122503, False], [[-0.06579255760134889, 1.3268467003328777, 5.531595097127407], [0.0, 0.0, 0.0], 0.12090058106424205, False], [[-0.042661843847079224, 2.0553030306836795, 7.2551007793587665], [0.0, 0.0, 0.0], 0.0628358384714946, False], [[-0.09211118715063556, 1.267408888894257, 7.827716375899725], [0.0, 0.0, 0.0], 0.07567094165901125, False], [[-0.06579255760134889, -1.3268467003328777, 5.531595097127407], [0.0, 0.0, 0.0], 0.12090058106424205, False], [[-0.042661843847079224, -2.0553030306836795, 7.2551007793587665], [0.0, 0.0, 0.0], 0.0628358384714946, False], [[-0.09211118715063556, -1.267408888894257, 7.827716375899725], [0.0, 0.0, 0.0], 0.07567094165901125, False]]
power_line_length = 1.0979999999999996 # 1.0979999999999996
steering_line_left = 1.6005947322165974 # 1.6005947322165974
steering_line_right = 1.6005947322165974 # 1.6005947322165974
spring_matrix = [[19, 2, 50000.0, 0.9, 1.3990213376738259, 'default'], [2, 18, 50000.0, 0.9, 1.7281439236583667, 'default'], [18, 1, 50000.0, 0.9, 1.2518030597706775, 'noncompressive'], [1, 19, 50000.0, 0.9, 0.7015380391093075, 'default'], [19, 18, 1000.0, 0.9, 1.3759487374332864, 'noncompressive'], [2, 1, 1000.0, 0.9, 1.9975700275639268, 'noncompressive'], [2, 3, 50000.0, 0.9, 1.5783185624280678, 'default'], [3, 17, 50000.0, 0.9, 2.249575398725647, 'default'], [17, 18, 50000.0, 0.9, 1.573796301066927, 'noncompressive'], [18, 2, 50000.0, 0.9, 1.7281439236583667, 'default'], [2, 17, 1000.0, 0.9, 2.551322622085479, 'noncompressive'], [3, 18, 1000.0, 0.9, 2.496687353016216, 'noncompressive'], [3, 4, 50000.0, 0.9, 1.4274159893458738, 'default'], [4, 16, 50000.0, 0.9, 2.5045334390096428, 'default'], [16, 17, 50000.0, 0.9, 1.4096486820629126, 'noncompressive'], [17, 3, 50000.0, 0.9, 2.249575398725647, 'default'], [3, 16, 1000.0, 0.9, 2.7440389803737433, 'noncompressive'], [4, 17, 1000.0, 0.9, 2.7861953570331908, 'noncompressive'], [4, 5, 50000.0, 0.9, 1.3468453098963156, 'default'], [5, 15, 50000.0, 0.9, 2.626427362762899, 'default'], [15, 16, 50000.0, 0.9, 1.3338104411792946, 'noncompressive'], [16, 4, 50000.0, 0.9, 2.5045334390096428, 'default'], [4, 15, 1000.0, 0.9, 2.8804368453103164, 'noncompressive'], [5, 16, 1000.0, 0.9, 2.907217779250614, 'noncompressive'], [5, 6, 50000.0, 0.9, 1.3339083103443277, 'default'], [6, 14, 50000.0, 0.9, 2.626427362762899, 'default'], [14, 15, 50000.0, 0.9, 1.3268175823618367, 'noncompressive'], [15, 5, 50000.0, 0.9, 2.626427362762899, 'default'], [5, 14, 1000.0, 0.9, 2.9441422675022175, 'noncompressive'], [6, 15, 1000.0, 0.9, 2.9441422675022175, 'noncompressive'], [6, 7, 50000.0, 0.9, 1.3468453098963156, 'default'], [7, 13, 50000.0, 0.9, 2.5045334390096428, 'default'], [13, 14, 50000.0, 0.9, 1.3338104411792946, 'noncompressive'], [14, 6, 50000.0, 0.9, 2.626427362762899, 'default'], [6, 13, 1000.0, 0.9, 2.907217779250614, 'noncompressive'], [7, 14, 1000.0, 0.9, 2.8804368453103164, 'noncompressive'], [7, 8, 50000.0, 0.9, 1.4274159893458738, 'default'], [8, 12, 50000.0, 0.9, 2.249575398725647, 'default'], [12, 13, 50000.0, 0.9, 1.4096486820629126, 'noncompressive'], [13, 7, 50000.0, 0.9, 2.5045334390096428, 'default'], [7, 12, 1000.0, 0.9, 2.7861953570331908, 'noncompressive'], [8, 13, 1000.0, 0.9, 2.7440389803737433, 'noncompressive'], [8, 9, 50000.0, 0.9, 1.5783185624280678, 'default'], [9, 11, 50000.0, 0.9, 1.7281439236583667, 'default'], [11, 12, 50000.0, 0.9, 1.573796301066927, 'noncompressive'], [12, 8, 50000.0, 0.9, 2.249575398725647, 'default'], [8, 11, 1000.0, 0.9, 2.496687353016216, 'noncompressive'], [9, 12, 1000.0, 0.9, 2.551322622085479, 'noncompressive'], [9, 20, 50000.0, 0.9, 1.3990213376738259, 'default'], [20, 10, 50000.0, 0.9, 0.7015380391093075, 'default'], [10, 11, 50000.0, 0.9, 1.2518030597706775, 'noncompressive'], [11, 9, 50000.0, 0.9, 1.7281439236583667, 'default'], [9, 10, 1000.0, 0.9, 1.9975700275639268, 'noncompressive'], [20, 11, 1000.0, 0.9, 1.3759487374332864, 'noncompressive'], [0, 21, 50000.0, 0.9, 0.95, 'noncompressive'], [21, 22, 50000.0, 0.9, power_line_length, 'noncompressive'], [21, 23, 50000.0, 0.9, steering_line_right, 'noncompressive'], [21, 27, 50000.0, 0.9, steering_line_left, 'noncompressive'], [23, 1, 50000.0, 0.9, 6.136472920477778, 'noncompressive'], [27, 10, 50000.0, 0.9, 6.136472920477778, 'noncompressive'], [24, 25, 50000.0, 0.9, 3.294446189671765, 'noncompressive'], [24, 26, 50000.0, 0.9, 3.2414638608775626, 'noncompressive'], [28, 29, 50000.0, 0.9, 3.294446189671765, 'noncompressive'], [28, 30, 50000.0, 0.9, 3.2414638608775626, 'noncompressive'], [25, 18, 50000.0, 0.9, 1.7114160066670918, 'noncompressive'], [25, 17, 50000.0, 0.9, 2.5300364156199593, 'noncompressive'], [29, 11, 50000.0, 0.9, 1.7114160066670918, 'noncompressive'], [29, 12, 50000.0, 0.9, 2.5300364156199593, 'noncompressive'], [26, 16, 50000.0, 0.9, 2.853244880514887, 'noncompressive'], [26, 15, 50000.0, 0.9, 3.194613594536709, 'noncompressive'], [30, 13, 50000.0, 0.9, 2.853244880514887, 'noncompressive'], [30, 14, 50000.0, 0.9, 3.194613594536709, 'noncompressive'], [0, 31, 50000.0, 0.9, 5.688883470891625, 'noncompressive'], [0, 34, 50000.0, 0.9, 5.688883470891625, 'noncompressive'], [31, 32, 50000.0, 0.9, 1.8712710898826828, 'noncompressive'], [31, 33, 50000.0, 0.9, 2.2970412383152796, 'noncompressive'], [34, 35, 50000.0, 0.9, 1.8712710898826828, 'noncompressive'], [34, 36, 50000.0, 0.9, 2.2970412383152796, 'noncompressive'], [32, 2, 50000.0, 0.9, 2.2941999331130436, 'noncompressive'], [32, 3, 50000.0, 0.9, 2.791491965569317, 'noncompressive'], [35, 9, 50000.0, 0.9, 2.2941999331130436, 'noncompressive'], [35, 8, 50000.0, 0.9, 2.791491965569317, 'noncompressive'], [33, 4, 50000.0, 0.9, 2.8814518651535197, 'noncompressive'], [33, 5, 50000.0, 0.9, 3.199527358061682, 'noncompressive'], [36, 7, 50000.0, 0.9, 2.8814518651535197, 'noncompressive'], [36, 6, 50000.0, 0.9, 3.199527358061682, 'noncompressive'], [24, 19, 50000.0, 0.9, 4.297613687231579, 'noncompressive'], [28, 20, 50000.0, 0.9, 4.297613687231579, 'noncompressive'], [31, 19, 50000.0, 0.9, 3.528491226341037, 'noncompressive'], [34, 20, 50000.0, 0.9, 3.528491226341037, 'noncompressive']]
pulley_matrix = [22,24,23,5000.0,0.9, 5.20445275136216],[22,28,27,5000.0,0.9, 5.20445275136216]

# Create FEM structure and show initial configuration
kite = FEM_structure(initial_conditions, spring_matrix=spring_matrix, pulley_matrix=pulley_matrix)

#setup external forces and solve
fe = np.array([5.907129052020721, 0.0, 1.9526610413851657, 0.0, 0.0, 0.0, 2.015164300914973, 7.446125789778666, 2.17662384683654, 0.0, 0.0, 0.0, -2.241614545265641, 87.04883707570737, 35.19190090029271, 0.0, 0.0, 0.0, -5.088668571284915, 131.06491501351405, 124.35294182705051, 0.0, 0.0, 0.0, -9.516065916794336, 91.82823795380547, 197.11645666147078, 0.0, 0.0, 0.0, -11.14547630385018, 31.955725253992284, 231.2055991164709, 0.0, 0.0, 0.0, -11.145476303849945, -31.95572525399233, 231.20559911647132, 0.0, 0.0, 0.0, -9.51606591679433, -91.82823795380547, 197.11645666147078, 0.0, 0.0, 0.0, -5.088668571284968, -131.06491501351383, 124.35294182705023, 0.0, 0.0, 0.0, -2.241614545265664, -87.04883707570727, 35.19190090029261, 0.0, 0.0, 0.0, 2.015164300914981, -7.446125789778677, 2.176623846836544, 0.0, 0.0, 0.0, -1.0883146061334417, -45.65634960612242, 17.553379013651032, 0.0, 0.0, 0.0, -2.0720126953780893, -62.41186429214944, 59.62901014852281, 0.0, 0.0, 0.0, -4.0488258280559, -43.727732358954995, 94.35066813619626, 0.0, 0.0, 0.0, -4.75204822735654, -15.217012025710634, 110.64644697251512, 0.0, 0.0, 0.0, -4.75204822735665, 15.217012025710615, 110.64644697251491, 0.0, 0.0, 0.0, -4.048825828055902, 43.72773235895499, 94.35066813619626, 0.0, 0.0, 0.0, -2.0720126953780635, 62.41186429214956, 59.62901014852295, 0.0, 0.0, 0.0, -1.0883146061334323, 45.65634960612251, 17.55337901365108, 0.0, 0.0, 0.0, 0.3319544741706002, 39.85502122122765, 6.275311425915698, 0.0, 0.0, 0.0, 0.3319544741706357, -39.85502122122762, 6.275311425915707, 0.0, 0.0, 0.0, 6.943984425887798, 0.0, 1.9541420163112841, 0.0, 0.0, 0.0, 2.7850539901986195, 0.0, 1.5314330527886186, 0.0, 0.0, 0.0, 4.269981430384881, 0.0, 2.1700379712646236, 0.0, 0.0, 0.0, 7.104255704461362, 0.0, 3.0302176450483893, 0.0, 0.0, 0.0, 3.2656607105813302, 0.0, 1.5640348931113555, 0.0, 0.0, 0.0, 3.8675557043145643, 0.0, 2.0449520669576273, 0.0, 0.0, 0.0, 4.269981430384881, 0.0, 2.1700379712646236, 0.0, 0.0, 0.0, 7.104255704461362, 0.0, 3.0302176450483893, 0.0, 0.0, 0.0, 3.2656607105813302, 0.0, 1.5640348931113555, 0.0, 0.0, 0.0, 3.8675557043145643, 0.0, 2.0449520669576273, 0.0, 0.0, 0.0, 6.229349134775813, 0.0, 2.3075755414136094, 0.0, 0.0, 0.0, 3.416395768582101, 0.0, 0.9437198382179653, 0.0, 0.0, 0.0, 4.143191118551853, 0.0, 1.0205688432130426, 0.0, 0.0, 0.0, 6.229349134775813, 0.0, 2.3075755414136094, 0.0, 0.0, 0.0, 3.416395768582101, 0.0, 0.9437198382179653, 0.0, 0.0, 0.0, 4.143191118551853, 0.0, 1.0205688432130426, 0.0, 0.0, 0.0])
ax1,fig1 = kite.plot_3D(color='black', plot_forces_displacements=False,show_plot=False)
kite.solve(fe=fe, max_iterations=1000, tolerance=1, step_limit=0.1, relax_init=.25, relax_update=0.95, k_update=1)
ax2,fig2 = kite.plot_3D(color='red',plot_forces_displacements=False,show_plot=False)
ax3, fig3 = kite.plot_convergence()

rest_lengths = kite.modify_get_spring_rest_length()
print(rest_lengths)
plt.show()


