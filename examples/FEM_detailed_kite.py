from pathlib import Path

from kitesim import (
    structural_kite_fem_level_2,
    read_struc_geometry_level_2_yaml,
)
from kitesim.utils import (
    load_yaml,
)
from kite_fem.FEMStructure import FEM_structure
from kite_fem.Plotting import (
    plot_structure,
    plot_structure_with_strain,
    plot_convergence,
    plot_structure_with_collapsed_beams,
    plot_cross_sections
)
from kite_fem.Functions import relaxbridles,fix_nodes,adapt_stiffnesses
from kite_fem.saveload import save_fem_structure,load_fem_structure

import matplotlib.pyplot as plt
import numpy as np


PROJECT_DIR = Path(__file__).resolve().parents[1]
kite_name = "TUDELFT_V3_KITE"  
struc_geometry_path = (
    Path(PROJECT_DIR)
    / "data"
    / f"{kite_name}"
    / "struc_geometry_all_in_surfplan.yaml"
)
struc_geometry = load_yaml(struc_geometry_path)

(
    # node level
    struc_nodes,
    m_arr,
    struc_node_le_indices,
    struc_node_te_indices,
    power_tape_index,
    steering_tape_indices,
    pulley_node_indices,
    canopy_sections,
    strut_sections,
    simplified_bridle_points,
    # element level
    kite_connectivity_arr,
    bridle_connectivity_arr,
    bridle_diameter_arr,
    l0_arr,
    k_arr,
    c_arr,
    linktype_arr,
    pulley_line_indices,
    pulley_line_to_other_node_pair_dict,
) = read_struc_geometry_level_2_yaml.main(struc_geometry)

config = {"is_with_initial_point_velocity": False}
kite = structural_kite_fem_level_2.instantiate(
    config,
    struc_geometry,
    struc_nodes,
    kite_connectivity_arr,
    l0_arr,
    k_arr,
    c_arr,
    m_arr,
    linktype_arr,
    pulley_line_to_other_node_pair_dict,
    canopy_sections,
    strut_sections,
)[0]

canopy_nodes = list(set([node for section in canopy_sections + strut_sections for node in section]))
all_sections = canopy_sections + strut_sections
all_sections.sort(key=lambda section: section[0])

fe = np.array([0.000000e+00, 0.000000e+00, -1.180260e+00, -5.474900e-01, 8.104600e-01,
 -1.953280e+00, -5.410000e-03, 8.000000e-03, -9.495000e-02, -4.705000e-02,
  8.104000e-02, -1.377770e+00, -4.661000e-02, 8.027000e-02, -1.068000e-01,
 -3.137100e-01, 6.819900e-01, -1.427700e+00, -2.063800e-01, 4.357700e-01,
 -4.203100e-01, -1.103240e+00, 4.262870e+00, -7.975400e-01, -3.626600e-01,
  1.313950e+00, -1.744800e-01, -1.145470e+00, 8.129060e+00, 1.110330e+00,
 -1.969800e-01, 1.343790e+00, 2.136600e-01, -1.214270e+00, 9.185460e+00,
  4.160290e+00, -1.697500e-01, 1.372770e+00, 5.836800e-01, -2.256420e+00,
  9.907550e+00, 9.953020e+00, -2.928000e-01, 1.346830e+00, 1.162870e+00,
 -1.705040e+00, 7.370770e+00, 7.979470e+00, -1.843800e-01, 7.756300e-01,
  8.395000e-01, -1.330390e+00, 7.929300e+00, 1.280122e+01, -1.069900e-01,
  5.750400e-01, 6.973700e-01, -1.580240e+00, 4.988250e+00, 1.462058e+01,
 -1.219000e-01, 3.585200e-01, 6.604300e-01, -1.371270e+00, 5.632720e+00,
  1.420044e+01, -8.116000e-02, 3.101300e-01, 7.304600e-01, -1.111610e+00,
  5.782920e+00, 2.148071e+01, -4.152000e-02, 2.553600e-01, 6.804000e-01,
 -1.306890e+00, -3.178600e-01, 1.293157e+01, -7.444000e-02, -1.360000e-02,
  2.793300e-01, -8.695900e-01, 2.915850e+00, 1.527374e+01, -2.317000e-02,
  7.546000e-02, 2.749600e-01, -1.067520e+00, 0.000000e+00, 1.332079e+01,
 -4.854000e-02, 0.000000e+00, 3.611900e-01, -8.539000e-01, -3.011590e+00,
  1.583336e+01, -2.067000e-02, -7.508000e-02, 1.380900e-01, -1.043700e+00,
  3.292200e-01, 1.413901e+01, -3.646000e-02, 1.038000e-02, 3.287100e-01,
 -1.014500e+00, -4.402800e+00, 1.894218e+01, -2.445000e-02, -9.572000e-02,
  3.241200e-01, -9.417500e-01, -3.472360e+00, 7.762910e+00, -3.826000e-02,
 -1.176800e-01, 3.020000e-03, -8.472700e-01, -2.823730e+00, 9.167490e+00,
 -2.361000e-02, -7.434000e-02, 1.029200e-01, -7.297000e-01, -4.825270e+00,
  8.585100e+00, -1.967000e-02, -1.214300e-01, 9.251000e-02, -8.179800e-01,
 -3.740930e+00, 3.352050e+00, -4.881000e-02, -2.235100e-01, 1.825000e-02,
 -1.588440e+00, -6.671870e+00, 6.809750e+00, -1.015200e-01, -4.302200e-01,
  3.767700e-01, -1.074850e+00, -8.008030e+00, 3.551770e+00, -6.016000e-02,
 -4.636600e-01, 1.450400e-01, -1.073770e+00, -7.666920e+00, 1.071430e+00,
 -7.937000e-02, -5.460100e-01, -5.455000e-02, -4.600800e-01, -1.576290e+00,
 -9.998300e-01, -7.854000e-02, -2.598200e-01, -1.024500e-01, -6.221000e-02,
 -1.261900e-01, -1.414080e+00, -1.612000e-02, -3.186000e-02, -5.468000e-02,
 -9.868600e-01, -1.567160e+00, -2.793790e+00, -6.325000e-02, -1.076300e-01,
 -2.056100e-01, -9.567400e-01, -3.360350e+00, 1.857180e+01, -1.071780e+00,
 -4.009650e+00, 9.981290e+00, 0.000000e+00, 0.000000e+00, -1.002870e+00,
 -2.352070e+00, -7.877270e+00, 4.350785e+01, 0.000000e+00, 0.000000e+00,
 -1.002410e+00, -8.980200e-01, -4.104700e+00, 4.605170e+00, -3.255860e+00,
 -1.391673e+01, 3.673571e+01, 0.000000e+00, 0.000000e+00, -1.002350e+00,
 -1.722070e+00, -7.821070e+00, 8.765140e+00, 0.000000e+00, 0.000000e+00,
 -1.038130e+00, 0.000000e+00, 0.000000e+00, -1.038080e+00, 0.000000e+00,
  0.000000e+00, -1.329400e-01, -1.177710e+00, -8.422980e+00, 2.099260e+00,
  0.000000e+00, 0.000000e+00, -7.487900e-01, 0.000000e+00, 0.000000e+00,
 -1.779900e+00, 0.000000e+00, 0.000000e+00, -1.364200e-01, 0.000000e+00,
  0.000000e+00, -1.015550e+00, 0.000000e+00, 0.000000e+00, -1.037880e+00,
 -2.288840e+00, -1.658898e+01, 3.898290e+00, -3.142800e-01, -1.128550e+00,
  4.204900e+00, -1.079930e+00, -3.218740e+00, 5.281660e+00, -1.746500e+00,
 -7.809260e+00, 7.473070e+00, 0.000000e+00, 0.000000e+00, -1.322720e+00,
  0.000000e+00, 0.000000e+00, -4.844600e-01, 0.000000e+00, 0.000000e+00,
 -6.416000e-02, 0.000000e+00, 0.000000e+00, -1.081000e-01, 0.000000e+00,
  0.000000e+00, -1.218300e-01, -2.749700e-01, -4.567800e-01, -6.771500e-01,
  0.000000e+00, 0.000000e+00, -1.125960e+00, -8.884000e-02, -1.508200e-01,
 -2.812900e-01, -1.036000e-01, -7.123500e-01, -3.967600e-01, -6.318000e-02,
 -2.892400e-01, -1.399930e+00, -4.928000e-02, -1.512800e-01, -1.579490e+00,
 -2.601000e-02, -9.445000e-02, -1.494310e+00, -1.444640e+00, -3.569500e-01,
  1.548899e+01, -1.690560e+00, 5.346990e+00, 1.664358e+01, 0.000000e+00,
  0.000000e+00, -1.002870e+00, -3.212200e+00, -9.038600e-01, 4.059153e+01,
  0.000000e+00, 0.000000e+00, -1.002410e+00, -2.379300e+00, 1.041883e+01,
  1.138531e+01, -2.499670e+00, 7.980430e+00, 2.551124e+01, 0.000000e+00,
  0.000000e+00, -1.002350e+00, -3.324750e+00, 1.426860e+01, 1.585086e+01,
  0.000000e+00, 0.000000e+00, -1.038130e+00, 0.000000e+00, 0.000000e+00,
 -1.038080e+00, 0.000000e+00, 0.000000e+00, -1.329400e-01, -1.147240e+00,
  4.439110e+00, 3.138000e-02, 0.000000e+00, 0.000000e+00, -1.097140e+00,
  0.000000e+00, 0.000000e+00, -1.779900e+00, 0.000000e+00, 0.000000e+00,
 -1.364200e-01, 0.000000e+00, 0.000000e+00, -1.015550e+00, 0.000000e+00,
  0.000000e+00, -1.037880e+00, -1.458590e+00, 5.695530e+00, -3.951000e-01,
 -1.534390e+00, -2.745700e-01, 9.179060e+00, -1.648200e+00, 4.894980e+00,
  1.106556e+01, -4.092170e+00, 1.739862e+01, 1.824384e+01, 0.000000e+00,
  0.000000e+00, -1.322720e+00, 0.000000e+00, 0.000000e+00, -4.844600e-01,
  0.000000e+00, 0.000000e+00, -6.416000e-02, 0.000000e+00, 0.000000e+00,
 -1.081000e-01, 0.000000e+00, 0.000000e+00, -1.218300e-01, -6.935000e-02,
  1.026600e-01, -2.838200e-01, 0.000000e+00, 0.000000e+00, -1.125960e+00,
 -9.050000e-03, 1.340000e-02, -1.286500e-01, -4.729500e-01, 1.714550e+00,
 -5.525100e-01, -3.744400e-01, 1.719970e+00, 6.044000e-02, -1.555800e-01,
  4.572700e-01, -7.456500e-01, -9.577000e-02, -1.744000e-02, -1.303190e+00,
  0.000000e+00, 0.000000e+00, -5.711400e-01, 0.000000e+00, 0.000000e+00,
 -3.626900e-01, 0.000000e+00, 0.000000e+00, -3.626900e-01, -1.412310e+00,
 -4.852940e+00, 2.643076e+01, -4.149940e+00, -1.484125e+01, 3.770918e+01,
 -9.306180e+00, -4.022520e+01, 4.833920e+01, -3.204370e+00, -7.430300e-01,
  3.176981e+01, -2.905050e+00, 9.143180e+00, 2.810604e+01, -5.575440e+00,
  2.300587e+01, 2.692805e+01, 0.000000e+00, 0.000000e+00, -2.767000e-02,
  0.000000e+00, 0.000000e+00, -2.715000e-02, 0.000000e+00, 0.000000e+00,
 -2.704000e-02, 0.000000e+00, 0.000000e+00, -2.767000e-02, 0.000000e+00,
  0.000000e+00, -2.715000e-02, 0.000000e+00, 0.000000e+00, -2.704000e-02,
 -3.379000e-02, 5.003000e-02, -1.814700e-01, -1.577000e-02, 2.335000e-02,
 -1.528200e-01, -1.026000e-02, 1.519000e-02, -8.971000e-02, -2.616950e+00,
  1.016209e+01, -8.118700e-01, -8.323700e-01, 3.030230e+00, -9.951800e-01,
 -1.887950e+00, -1.299582e+01, 1.881570e+00, -1.901900e-01, -1.305780e+00,
 -7.153300e-01, -1.896700e-01, -3.184700e-01, -4.796600e-01, -1.244700e-01,
 -2.105400e-01, -3.607500e-01, -9.611000e-02, -1.630400e-01, -2.539400e-01,
 -7.219000e-02, 1.243300e-01, -1.555300e-01, -1.089200e-01, 1.875800e-01,
 -2.586900e-01, -5.821300e-01, 1.002550e+00, -1.204490e+00, -1.898000e-01,
  3.268800e-01, -4.390200e-01, -8.634000e-02, 1.487000e-01, -2.077900e-01,
 -3.188600e-01, 6.932700e-01, -5.629000e-01, -4.011100e-01, 8.738300e-01,
 -8.612800e-01, -1.303230e+00, 2.856130e+00, -2.461980e+00, -5.898500e-01,
  1.244310e+00, -1.408070e+00, -2.842500e-01, 5.996600e-01, -7.305000e-01,
 -1.192520e+00, 8.474300e+00, 2.133080e+00, -1.507150e+00, 1.080209e+01,
  2.605400e+00, -1.846360e+00, 1.321602e+01, 3.009760e+00, -6.626100e-01,
  4.564330e+00, 4.913400e-01, -2.503400e-01, 1.709260e+00, -4.540000e-03,
 -1.271350e+00, 9.585910e+00, 5.312680e+00, -1.667760e+00, 1.229976e+01,
  6.877290e+00, -2.335560e+00, 1.671048e+01, 9.637870e+00, -1.035310e+00,
  8.005350e+00, 3.530650e+00, -2.163600e-01, 1.746080e+00, 1.877200e-01,
 -1.812030e+00, 7.845670e+00, 9.442330e+00, -2.668170e+00, 1.169126e+01,
  1.384329e+01, -4.722920e+00, 2.116441e+01, 2.464179e+01, -3.272700e+00,
  1.436653e+01, 1.633565e+01, -2.374900e-01, 9.996400e-01, 4.115700e-01,
 -1.421460e+00, 8.503570e+00, 1.476605e+01, -2.080130e+00, 1.270284e+01,
  2.260879e+01, -2.387440e+00, 1.423858e+01, 2.437898e+01, -1.415860e+00,
  7.742140e+00, 1.058935e+01, -1.366200e-01, 7.336000e-01, 1.061000e-01,
 -1.466000e+00, 6.011980e+00, 1.603834e+01, -2.199050e+00, 8.730270e+00,
  2.250240e+01, -3.692790e+00, 1.287715e+01, 3.133358e+01, -1.673200e+00,
  5.771770e+00, 1.359914e+01, -1.033200e-01, 3.936600e-01, 1.225000e-01,
 -1.219140e+00, 6.247780e+00, 2.450719e+01, -2.603260e+00, 1.139603e+01,
  5.042114e+01, -1.820970e+00, 8.725860e+00, 3.586420e+01, -5.414500e-01,
  3.132650e+00, 9.781160e+00, -5.215000e-02, 3.204900e-01, 2.571000e-02,
 -9.699100e-01, 3.265310e+00, 1.810448e+01, -2.281280e+00, 8.077640e+00,
  4.493365e+01, -1.408760e+00, 4.808050e+00, 2.648940e+01, -3.541000e-01,
  1.162850e+00, 5.391520e+00, -2.918000e-02, 9.507000e-02, -4.888400e-01,
 -1.179190e+00, 0.000000e+00, 1.578242e+01, -2.695920e+00, -0.000000e+00,
  4.065096e+01, -3.675440e+00, 0.000000e+00, 3.339678e+01, -1.321490e+00,
  0.000000e+00, 9.818470e+00, -6.232000e-02, 0.000000e+00, -3.740700e-01,
 -1.143690e+00, 3.602400e-01, 1.643088e+01, -1.960260e+00, 5.912600e-01,
  2.665618e+01, -5.658100e+00, 1.102490e+00, 4.607143e+01, -9.840600e-01,
  2.205800e-01, 8.530730e+00, -4.642000e-02, 1.314000e-02, -4.121300e-01,
 -1.140590e+00, -5.025170e+00, 2.238200e+01, -3.055380e+00, -1.578417e+01,
  6.142033e+01, -1.763460e+00, -8.950270e+00, 3.430373e+01, -3.609700e-01,
 -1.482510e+00, 5.871120e+00, -3.074000e-02, -1.204400e-01, -3.959900e-01,
 -9.626000e-01, -3.216020e+00, 1.149415e+01, -2.524600e+00, -8.665770e+00,
  3.159141e+01, -5.479860e+00, -1.611358e+01, 4.186446e+01, -7.330500e-01,
 -2.181240e+00, 4.991650e+00, -3.020000e-02, -9.494000e-02, -6.511000e-01,
 -8.278800e-01, -5.476050e+00, 1.078995e+01, -2.128350e+00, -1.402108e+01,
  2.791165e+01, -4.546410e+00, -2.445426e+01, 3.498825e+01, -6.017300e-01,
 -3.372240e+00, 4.320770e+00, -2.514000e-02, -1.547600e-01, -5.572900e-01,
 -1.737410e+00, -7.297020e+00, 8.446330e+00, -3.226850e+00, -1.355298e+01,
  1.559408e+01, -1.055121e+01, -4.547267e+01, 5.103322e+01, -9.584100e-01,
 -4.084150e+00, 3.855620e+00, -1.314700e-01, -5.573700e-01, -7.113000e-02,
 -1.189550e+00, -8.843410e+00, 4.962240e+00, -2.485500e+00, -1.813259e+01,
  1.038823e+01, -2.765560e+00, -2.087747e+01, 1.128685e+01, -2.568100e-01,
 -1.979810e+00, 5.212300e-01, -7.794000e-02, -6.008400e-01, -7.383000e-02,
 -1.128620e+00, -4.016250e+00, -1.171600e-01, -4.883940e+00, -2.000084e+01,
  9.727900e-01, -1.117330e+00, -3.689980e+00, -4.944000e-01, -2.036300e-01,
 -6.723500e-01, -3.869600e-01, -1.218600e-01, -4.027900e-01, -2.666800e-01,
 -2.094940e+00, -4.768000e+00, -3.078360e+00, -9.731500e-01, -1.925520e+00,
 -1.849480e+00, -1.921600e-01, -3.779000e-01, -4.312100e-01, -4.696000e-02,
 -9.263000e-02, -1.421700e-01, -3.184000e-02, -6.286000e-02, -1.010100e-01])

fe = fe.reshape(-1,3)
fe = np.hstack([fe, np.zeros((fe.shape[0], 3))])
fe = fe.flatten()
print(fe)

ax1,fig1 = plot_structure(kite,plot_nodes=False,fe=fe,plot_external_forces=False,linewidth = [1,0.75,1,3.5],plot_node_numbers=False)
ax2,fig2 = plot_structure(kite, plot_nodes=False,plot_displacements=False,solver="spsolve",e_colors = ['black', 'black', 'black', 'black'],linewidth = [1,0.75,1,3.5],plot_2d=True,plot_2d_plane="yz")
kite.solve(fe=fe, max_iterations=100, tolerance=0.01, step_limit=.005, relax_init=.25, relax_min=0.00, relax_update=0.998, k_update=1,I_stiffness=15)

# plot_cross_sections(kite,all_sections)
ax3,fig3 = plot_structure(kite,fe_magnitude=1.5, plot_residual_forces=False,plot_external_forces=True,plot_nodes=False,plot_displacements=True,solver="spsolve",linewidth = [1,0.75,1,3.5])
ax2,fig2 = plot_structure(kite,plot_nodes=False,plot_external_forces=True,plot_displacements=False,solver="spsolve",e_colors = ['red', 'red', 'red', 'red'], linewidth = [1,0.75,1,3.5],plot_2d=True,plot_2d_plane="yz")
ax4,fig4 = plot_structure_with_strain(kite)
ax5,fig5 = plot_structure_with_collapsed_beams(kite,plot_nodes=False)

# ax3.legend()
# ax2.set_title("Initial (black) vs Final (red)")
# ax3.set_title("Final")
plt.show()