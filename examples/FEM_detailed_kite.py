from pathlib import Path

from kitesim import (
    structural_kite_fem_level_2,
    read_struc_geometry_level_2_yaml,
)
from kitesim.utils import (
    load_yaml,
)
from kite_fem.FEMStructure import FEM_structure
from kite_fem.Plotting import (
    plot_structure,
    plot_structure_with_strain,
    plot_convergence,
    plot_structure_with_collapsed_beams,
    plot_cross_sections
)
from kite_fem.Functions import relaxbridles,fix_nodes,adapt_stiffnesses
from kite_fem.saveload import save_fem_structure,load_fem_structure

import matplotlib.pyplot as plt
import numpy as np


PROJECT_DIR = Path(__file__).resolve().parents[1]
kite_name = "TUDELFT_V3_KITE"  
struc_geometry_path = (
    Path(PROJECT_DIR)
    / "data"
    / f"{kite_name}"
    / "struc_geometry_all_in_surfplan.yaml"
)
struc_geometry = load_yaml(struc_geometry_path)

(
    # node level
    struc_nodes,
    m_arr,
    struc_node_le_indices,
    struc_node_te_indices,
    power_tape_index,
    steering_tape_indices,
    pulley_node_indices,
    canopy_sections,
    strut_sections,
    simplified_bridle_points,
    # element level
    kite_connectivity_arr,
    bridle_connectivity_arr,
    bridle_diameter_arr,
    l0_arr,
    k_arr,
    c_arr,
    linktype_arr,
    pulley_line_indices,
    pulley_line_to_other_node_pair_dict,
) = read_struc_geometry_level_2_yaml.main(struc_geometry)

config = {"is_with_initial_point_velocity": False}
kite = structural_kite_fem_level_2.instantiate(
    config,
    struc_geometry,
    struc_nodes,
    kite_connectivity_arr,
    l0_arr,
    k_arr,
    c_arr,
    m_arr,
    linktype_arr,
    pulley_line_to_other_node_pair_dict,
    canopy_sections,
    strut_sections,
)[0]

canopy_nodes = list(set([node for section in canopy_sections + strut_sections for node in section]))
all_sections = canopy_sections + strut_sections
all_sections.sort(key=lambda section: section[0])

fe = np.array([
    0.0000000e+00, 0.0000000e+00, -1.1802600e+00, -1.5647900e+00,
    2.5290600e+00, -3.8994700e+00, -3.3800000e-03, 5.0100000e-03,
    -9.1080000e-02, -2.4619700e+00, 5.3434000e+00, -5.1832300e+00,
    -8.4578000e-01, 2.1329500e+00, -9.0420000e-01, -5.6731700e+00,
    2.1467620e+01, -7.4632000e-01, -9.8119000e-01, 2.9645500e+00,
    -6.6943000e-01, -6.1830100e+00, 3.9095820e+01, 7.8615800e+00,
    -6.0510000e-01, 3.4110700e+00, 4.1945000e-01, -6.8953800e+00,
    5.1376310e+01, 2.4912290e+01, -7.6096000e-01, 5.1292900e+00,
    2.5597300e+00, -1.3323080e+01, 6.3111820e+01, 6.2807150e+01,
    -9.5750000e-01, 5.0342000e+00, 4.3669900e+00, -1.4347800e+01,
    6.1128980e+01, 7.2711330e+01, -9.6853000e-01, 4.0784000e+00,
    4.7168700e+00, -1.0641820e+01, 5.5794340e+01, 8.2658210e+01,
    -6.8673000e-01, 3.2169300e+00, 4.0259900e+00, -9.4924000e+00,
    3.7447430e+01, 9.3114640e+01, -4.5167000e-01, 1.8108500e+00,
    3.3268600e+00, -9.8364000e+00, 3.6328840e+01, 1.0132266e+02,
    -4.5751000e-01, 1.4152400e+00, 3.2889300e+00, -7.7689700e+00,
    3.4998910e+01, 1.1317045e+02, -2.8992000e-01, 1.0710700e+00,
    3.0061200e+00, -8.4531700e+00, 1.1135280e+01, 1.0983264e+02,
    -3.1459000e-01, 3.0514000e-01, 3.2183600e+00, -8.0071300e+00,
    8.7467000e+00, 1.1484925e+02, -2.9209000e-01, 1.4638000e-01,
    2.7088100e+00, -7.5996400e+00, 9.9421300e+00, 1.1123843e+02,
    -2.7258000e-01, 1.9124000e-01, 2.6934000e+00, -7.5996400e+00,
    -9.9421300e+00, 1.1123843e+02, -2.7258000e-01, -1.9124000e-01,
    2.6934000e+00, -8.0071300e+00, -8.7467000e+00, 1.1484925e+02,
    -2.9209000e-01, -1.4638000e-01, 2.7088100e+00, -8.4531700e+00,
    -1.1135280e+01, 1.0983264e+02, -3.1459000e-01, -3.0514000e-01,
    3.2183600e+00, -7.7689700e+00, -3.4998910e+01, 1.1317045e+02,
    -2.8992000e-01, -1.0710700e+00, 3.0061200e+00, -9.8364000e+00,
    -3.6328840e+01, 1.0132266e+02, -4.5751000e-01, -1.4152400e+00,
    3.2889300e+00, -9.4924000e+00, -3.7447430e+01, 9.3114640e+01,
    -4.5167000e-01, -1.8108500e+00, 3.3268600e+00, -1.0641820e+01,
    -5.5794340e+01, 8.2658210e+01, -6.8673000e-01, -3.2169300e+00,
    4.0259900e+00, -1.4347800e+01, -6.1128980e+01, 7.2711330e+01,
    -9.6853000e-01, -4.0784000e+00, 4.7168700e+00, -1.3323080e+01,
    -6.3111820e+01, 6.2807150e+01, -9.5750000e-01, -5.0342000e+00,
    4.3669900e+00, -6.8953800e+00, -5.1376310e+01, 2.4887040e+01,
    -7.6096000e-01, -5.1292900e+00, 2.5479500e+00, -6.1830100e+00,
    -3.9095820e+01, 7.8615800e+00, -6.0510000e-01, -3.4110700e+00,
    4.1945000e-01, -5.6731700e+00, -2.1467620e+01, -7.8696000e-01,
    -9.8119000e-01, -2.9645500e+00, -6.8839000e-01, -2.4619700e+00,
    -5.3434000e+00, -5.1986200e+00, -8.4578000e-01, -2.1329500e+00,
    -9.1137000e-01, -1.5647900e+00, -2.5290600e+00, -3.8994700e+00,
    -3.3800000e-03, -5.0100000e-03, -9.1080000e-02, 0.0000000e+00,
    0.0000000e+00, -1.9919000e-01, 0.0000000e+00, 0.0000000e+00,
    -1.8965000e-01, 0.0000000e+00, 0.0000000e+00, -1.0028700e+00,
    0.0000000e+00, 0.0000000e+00, -4.1012000e-01, 0.0000000e+00,
    0.0000000e+00, -1.0024100e+00, 0.0000000e+00, 0.0000000e+00,
    -1.7050000e-01, 0.0000000e+00, 0.0000000e+00, -3.7755000e-01,
    0.0000000e+00, 0.0000000e+00, -1.0023500e+00, 0.0000000e+00,
    0.0000000e+00, -3.7818000e-01, 0.0000000e+00, 0.0000000e+00,
    -1.0381300e+00, 0.0000000e+00, 0.0000000e+00, -1.0380800e+00,
    0.0000000e+00, 0.0000000e+00, -1.3294000e-01, 0.0000000e+00,
    0.0000000e+00, -1.3110000e-01, 0.0000000e+00, 0.0000000e+00,
    -7.4879000e-01, 0.0000000e+00, 0.0000000e+00, -1.7799000e+00,
    0.0000000e+00, 0.0000000e+00, -1.3642000e-01, 0.0000000e+00,
    0.0000000e+00, -1.0155500e+00, 0.0000000e+00, 0.0000000e+00,
    -1.0378800e+00, 0.0000000e+00, 0.0000000e+00, -6.2583000e-01,
    0.0000000e+00, 0.0000000e+00, -2.1054300e+00, 0.0000000e+00,
    0.0000000e+00, -2.0208900e+00, 0.0000000e+00, 0.0000000e+00,
    -1.7767200e+00, 0.0000000e+00, 0.0000000e+00, -1.3227200e+00,
    0.0000000e+00, 0.0000000e+00, -4.8446000e-01, 0.0000000e+00,
    0.0000000e+00, -6.4160000e-02, 0.0000000e+00, 0.0000000e+00,
    -1.0810000e-01, 0.0000000e+00, 0.0000000e+00, -1.2183000e-01,
    0.0000000e+00, 0.0000000e+00, -1.5108000e-01, 0.0000000e+00,
    0.0000000e+00, -1.1259600e+00, 0.0000000e+00, 0.0000000e+00,
    -1.1133000e-01, 0.0000000e+00, 0.0000000e+00, -5.6732000e-01,
    0.0000000e+00, 0.0000000e+00, -1.7361500e+00, 0.0000000e+00,
    0.0000000e+00, -1.9286100e+00, 0.0000000e+00, 0.0000000e+00,
    -2.0226900e+00, 0.0000000e+00, 0.0000000e+00, -1.9919000e-01,
    0.0000000e+00, 0.0000000e+00, -1.8965000e-01, 0.0000000e+00,
    0.0000000e+00, -1.0028700e+00, 0.0000000e+00, 0.0000000e+00,
    -4.1012000e-01, 0.0000000e+00, 0.0000000e+00, -1.0024100e+00,
    0.0000000e+00, 0.0000000e+00, -1.7050000e-01, 0.0000000e+00,
    0.0000000e+00, -3.7755000e-01, 0.0000000e+00, 0.0000000e+00,
    -1.0023500e+00, 0.0000000e+00, 0.0000000e+00, -3.7818000e-01,
    0.0000000e+00, 0.0000000e+00, -1.0381300e+00, 0.0000000e+00,
    0.0000000e+00, -1.0380800e+00, 0.0000000e+00, 0.0000000e+00,
    -1.3294000e-01, 0.0000000e+00, 0.0000000e+00, -1.3110000e-01,
    0.0000000e+00, 0.0000000e+00, -1.0971400e+00, 0.0000000e+00,
    0.0000000e+00, -1.7799000e+00, 0.0000000e+00, 0.0000000e+00,
    -1.3642000e-01, 0.0000000e+00, 0.0000000e+00, -1.0155500e+00,
    0.0000000e+00, 0.0000000e+00, -1.0378800e+00, 0.0000000e+00,
    0.0000000e+00, -6.2583000e-01, 0.0000000e+00, 0.0000000e+00,
    -2.1054300e+00, 0.0000000e+00, 0.0000000e+00, -2.0208900e+00,
    0.0000000e+00, 0.0000000e+00, -1.7767200e+00, 0.0000000e+00,
    0.0000000e+00, -1.3227200e+00, 0.0000000e+00, 0.0000000e+00,
    -4.8446000e-01, 0.0000000e+00, 0.0000000e+00, -6.4160000e-02,
    0.0000000e+00, 0.0000000e+00, -1.0810000e-01, 0.0000000e+00,
    0.0000000e+00, -1.2183000e-01, 0.0000000e+00, 0.0000000e+00,
    -1.5108000e-01, 0.0000000e+00, 0.0000000e+00, -1.1259600e+00,
    0.0000000e+00, 0.0000000e+00, -1.1133000e-01, 0.0000000e+00,
    0.0000000e+00, -5.6732000e-01, 0.0000000e+00, 0.0000000e+00,
    -1.7361500e+00, 0.0000000e+00, 0.0000000e+00, -1.9286100e+00,
    0.0000000e+00, 0.0000000e+00, -2.0226900e+00, 0.0000000e+00,
    0.0000000e+00, -5.7114000e-01, 0.0000000e+00, 0.0000000e+00,
    -3.6269000e-01, 0.0000000e+00, 0.0000000e+00, -3.6269000e-01,
    0.0000000e+00, 0.0000000e+00, -6.5341000e-01, 0.0000000e+00,
    0.0000000e+00, -6.2283000e-01, 0.0000000e+00, 0.0000000e+00,
    -5.5990000e-01, 0.0000000e+00, 0.0000000e+00, -6.5341000e-01,
    0.0000000e+00, 0.0000000e+00, -6.2283000e-01, 0.0000000e+00,
    0.0000000e+00, -5.5990000e-01, 0.0000000e+00, 0.0000000e+00,
    -2.7670000e-02, 0.0000000e+00, 0.0000000e+00, -2.7150000e-02,
    0.0000000e+00, 0.0000000e+00, -2.7040000e-02, 0.0000000e+00,
    0.0000000e+00, -2.7670000e-02, 0.0000000e+00, 0.0000000e+00,
    -2.7150000e-02, 0.0000000e+00, 0.0000000e+00, -2.7040000e-02,
    0.0000000e+00, 0.0000000e+00, -1.1680000e-01, 0.0000000e+00,
    0.0000000e+00, -1.2264000e-01, 0.0000000e+00, 0.0000000e+00,
    -7.0080000e-02, 0.0000000e+00, 0.0000000e+00, -1.1976700e+00,
    0.0000000e+00, 0.0000000e+00, -1.0265700e+00, 0.0000000e+00,
    0.0000000e+00, -1.1976700e+00, 0.0000000e+00, 0.0000000e+00,
    -1.0265700e+00, 0.0000000e+00, 0.0000000e+00, -1.1680000e-01,
    0.0000000e+00, 0.0000000e+00, -1.2264000e-01, 0.0000000e+00,
    0.0000000e+00, -7.0080000e-02, 0.0000000e+00, 0.0000000e+00,
    -1.7430000e-02, 0.0000000e+00, 0.0000000e+00, -5.0330000e-02,
    0.0000000e+00, 0.0000000e+00, -9.0890000e-02, 0.0000000e+00,
    0.0000000e+00, -7.5940000e-02, 0.0000000e+00, 0.0000000e+00,
    -4.2620000e-02, 0.0000000e+00, 0.0000000e+00, -5.6470000e-02,
    0.0000000e+00, 0.0000000e+00, -2.2651000e-01, 0.0000000e+00,
    0.0000000e+00, -4.2236000e-01, 0.0000000e+00, 0.0000000e+00,
    -4.2011000e-01, 0.0000000e+00, 0.0000000e+00, -2.5443000e-01,
    0.0000000e+00, 0.0000000e+00, -6.5920000e-02, 0.0000000e+00,
    0.0000000e+00, -2.7070000e-01, 0.0000000e+00, 0.0000000e+00,
    -4.9914000e-01, 0.0000000e+00, 0.0000000e+00, -5.8938000e-01,
    0.0000000e+00, 0.0000000e+00, -3.9875000e-01, 0.0000000e+00,
    0.0000000e+00, -8.5090000e-02, 0.0000000e+00, 0.0000000e+00,
    -2.4658000e-01, 0.0000000e+00, 0.0000000e+00, -4.1562000e-01,
    0.0000000e+00, 0.0000000e+00, -8.3205000e-01, 0.0000000e+00,
    0.0000000e+00, -7.1084000e-01, 0.0000000e+00, 0.0000000e+00,
    -8.9490000e-02, 0.0000000e+00, 0.0000000e+00, -2.1807000e-01,
    0.0000000e+00, 0.0000000e+00, -3.5043000e-01, 0.0000000e+00,
    0.0000000e+00, -9.1542000e-01, 0.0000000e+00, 0.0000000e+00,
    -8.3315000e-01, 0.0000000e+00, 0.0000000e+00, -9.5940000e-02,
    0.0000000e+00, 0.0000000e+00, -1.9843000e-01, 0.0000000e+00,
    0.0000000e+00, -3.1489000e-01, 0.0000000e+00, 0.0000000e+00,
    -1.0177500e+00, 0.0000000e+00, 0.0000000e+00, -9.5524000e-01,
    0.0000000e+00, 0.0000000e+00, -9.8410000e-02, 0.0000000e+00,
    0.0000000e+00, -2.0098000e-01, 0.0000000e+00, 0.0000000e+00,
    -3.2293000e-01, 0.0000000e+00, 0.0000000e+00, -1.0456900e+00,
    0.0000000e+00, 0.0000000e+00, -9.7887000e-01, 0.0000000e+00,
    0.0000000e+00, -1.0143000e-01, 0.0000000e+00, 0.0000000e+00,
    -2.0780000e-01, 0.0000000e+00, 0.0000000e+00, -3.3294000e-01,
    0.0000000e+00, 0.0000000e+00, -1.0781400e+00, 0.0000000e+00,
    0.0000000e+00, -1.0100700e+00, 0.0000000e+00, 0.0000000e+00,
    -1.0219000e-01, 0.0000000e+00, 0.0000000e+00, -2.1056000e-01,
    0.0000000e+00, 0.0000000e+00, -3.3548000e-01, 0.0000000e+00,
    0.0000000e+00, -1.0855100e+00, 0.0000000e+00, 0.0000000e+00,
    -1.0182100e+00, 0.0000000e+00, 0.0000000e+00, -1.0219000e-01,
    0.0000000e+00, 0.0000000e+00, -2.1056000e-01, 0.0000000e+00,
    0.0000000e+00, -3.3548000e-01, 0.0000000e+00, 0.0000000e+00,
    -1.0855100e+00, 0.0000000e+00, 0.0000000e+00, -1.0182100e+00,
    0.0000000e+00, 0.0000000e+00, -1.0143000e-01, 0.0000000e+00,
    0.0000000e+00, -2.0781000e-01, 0.0000000e+00, 0.0000000e+00,
    -3.3294000e-01, 0.0000000e+00, 0.0000000e+00, -1.0781400e+00,
    0.0000000e+00, 0.0000000e+00, -1.0100700e+00, 0.0000000e+00,
    0.0000000e+00, -9.8410000e-02, 0.0000000e+00, 0.0000000e+00,
    -2.0097000e-01, 0.0000000e+00, 0.0000000e+00, -3.2293000e-01,
    0.0000000e+00, 0.0000000e+00, -1.0456900e+00, 0.0000000e+00,
    0.0000000e+00, -9.7887000e-01, 0.0000000e+00, 0.0000000e+00,
    -9.5940000e-02, 0.0000000e+00, 0.0000000e+00, -1.9843000e-01,
    0.0000000e+00, 0.0000000e+00, -3.1489000e-01, 0.0000000e+00,
    0.0000000e+00, -1.0177600e+00, 0.0000000e+00, 0.0000000e+00,
    -9.5524000e-01, 0.0000000e+00, 0.0000000e+00, -8.9490000e-02,
    0.0000000e+00, 0.0000000e+00, -2.1695000e-01, 0.0000000e+00,
    0.0000000e+00, -3.4782000e-01, 0.0000000e+00, 0.0000000e+00,
    -9.1654000e-01, 0.0000000e+00, 0.0000000e+00, -8.3576000e-01,
    0.0000000e+00, 0.0000000e+00, -8.5090000e-02, 0.0000000e+00,
    0.0000000e+00, -2.4461000e-01, 0.0000000e+00, 0.0000000e+00,
    -4.1106000e-01, 0.0000000e+00, 0.0000000e+00, -8.3402000e-01,
    0.0000000e+00, 0.0000000e+00, -7.1540000e-01, 0.0000000e+00,
    0.0000000e+00, -9.7230000e-02, 0.0000000e+00, 0.0000000e+00,
    -2.6688000e-01, 0.0000000e+00, 0.0000000e+00, -4.6589000e-01,
    0.0000000e+00, 0.0000000e+00, -5.5617000e-01, 0.0000000e+00,
    0.0000000e+00, -4.0068000e-01, 0.0000000e+00, 0.0000000e+00,
    -1.0686000e-01, 0.0000000e+00, 0.0000000e+00, -2.2204000e-01,
    0.0000000e+00, 0.0000000e+00, -3.7273000e-01, 0.0000000e+00,
    0.0000000e+00, -3.6500000e-01, 0.0000000e+00, 0.0000000e+00,
    -2.5368000e-01, 0.0000000e+00, 0.0000000e+00, -3.6500000e-02,
    0.0000000e+00, 0.0000000e+00, -4.8830000e-02, 0.0000000e+00,
    0.0000000e+00, -7.2550000e-02, 0.0000000e+00, 0.0000000e+00,
    -5.4890000e-02, 0.0000000e+00, 0.0000000e+00, -4.1890000e-02
])

fe = fe.reshape(-1,3)
fe = np.hstack([fe, np.zeros((fe.shape[0], 3))])
fe = fe.flatten()
print(fe)

ax1,fig1 = plot_structure(kite,plot_nodes=False,fe=fe,plot_external_forces=True,linewidth = [1,0.75,1,3.5],plot_node_numbers=True)
ax2,fig2 = plot_structure(kite, plot_nodes=False,plot_displacements=False,solver="spsolve",e_colors = ['black', 'black', 'black', 'black'],linewidth = [1,0.75,1,3.5],plot_2d=True,plot_2d_plane="yz")
kite.solve(fe=fe, max_iterations=1000, tolerance=0.01, step_limit=.005, relax_init=.25, relax_min=0.00, relax_update=0.998, k_update=1,I_stiffness=15)

# plot_cross_sections(kite,all_sections)
ax3,fig3 = plot_structure(kite,fe_magnitude=1.5, plot_residual_forces=False,plot_external_forces=True,plot_nodes=False,plot_displacements=True,solver="spsolve",linewidth = [1,0.75,1,3.5])
ax2,fig2 = plot_structure(kite,plot_nodes=False,plot_external_forces=True,plot_displacements=False,solver="spsolve",e_colors = ['red', 'red', 'red', 'red'], linewidth = [1,0.75,1,3.5],plot_2d=True,plot_2d_plane="yz")
ax4,fig4 = plot_structure_with_strain(kite)
ax5,fig5 = plot_structure_with_collapsed_beams(kite,plot_nodes=False)

# ax3.legend()
# ax2.set_title("Initial (black) vs Final (red)")
# ax3.set_title("Final")
plt.show()